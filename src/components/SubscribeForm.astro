---
import Button from '../components/Button.astro';
import Modal from '../components/Modal.astro';
import { getTranslations} from '../translations/index.ts';

// Haal huidige taal op van Astro
const currentLocale = Astro.currentLocale || 'en';
const t = getTranslations(currentLocale);
---

<form id="subscribe-form" class="w-full max-w-md space-y-4" novalidate>
    <div class="flex space-x-2">
        <input
            type="email"
            name="email"
            id="email"
            required
            placeholder={t.subscribeForm.emailPlaceholder}
            class="flex-grow px-4 py-2 border border-gray rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green focus:border-green transition-all text-black bg-cream font-text text-xl"
        />
        <select 
            id="language" 
            name="language"
            class="p-2 border border-gray rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green focus:border-green transition-all text-black text-xl bg-cream"
            required
        >
            <option value="en" selected={currentLocale === 'en'}>ðŸ‡¬ðŸ‡§</option>
            <option value="nl" selected={currentLocale === 'nl'}>ðŸ‡³ðŸ‡±</option>
        </select>
    </div>
    <Button type="submit" id="submit-button" content={t.subscribeForm.submitButton} />
</form>

<Modal id="feedback-modal" />

<script define:vars={{ 
    frontendUrl: import.meta.env.PUBLIC_FRONTEND_URL || 'http://localhost:4321',
    t: t.subscribeForm
}}>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('subscribe-form');
        const submitButton = document.getElementById('submit-button');
        const emailInput = document.getElementById('email');
        const languageSelect = document.getElementById('language');

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Show loading state
                submitButton.disabled = true;
                submitButton.innerHTML = t.loadingText;

                const email = emailInput.value.trim();
                if (!email || !validateEmail(email)) {
                    window.ModalFunctions.showModal('feedback-modal', t.validationError, false);
                    submitButton.disabled = false;
                    submitButton.innerHTML = t.submitButton;
                    return;
                }

                try {
                    const language = languageSelect.value;
                    
                    // Gebruik de nieuwe API endpoint in plaats van direct Sendy aan te roepen
                    const response = await fetch('/api/subscribe', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email, language })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        window.ModalFunctions.showModal('feedback-modal', t.success, true);
                        form.reset();
                    } else {
                        // Afhandeling van specifieke foutcodes
                        switch(result.error) {
                            case 'already_subscribed':
                                window.ModalFunctions.showModal('feedback-modal', t.alreadySubscribed, false);
                                break;
                            case 'invalid_email':
                                window.ModalFunctions.showModal('feedback-modal', t.validationError, false);
                                break;
                            default:
                                window.ModalFunctions.showModal('feedback-modal', t.errorMessage, false);
                                console.error('API error:', result.message);
                        }
                    }
                } catch (error) {
                    console.error('API call error:', error);
                    window.ModalFunctions.showModal('feedback-modal', t.connectionError, false);
                } finally {
                    // Restore button
                    submitButton.disabled = false;
                    submitButton.innerHTML = t.submitButton;
                }
            });
        }
    });
</script>